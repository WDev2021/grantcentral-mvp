<script>
  async function searchGrants() {
    const keywordInput = document.getElementById('keyword');
    const keyword = keywordInput.value.trim();
    const resultsDiv = document.getElementById('results');
    const loading = document.getElementById('loading');
    
    resultsDiv.innerHTML = '';
    loading.textContent = 'Loading fresh opportunities from Grants.gov...';

    const payload = {
      query: {
        keywords: keyword ? keyword.split(/\s+/) : [],
        opportunityStatuses: ['posted', 'forecasted']
      },
      pagination: { page: 1, size: 50 },
      sort: { field: 'closeDate', direction: 'asc' }
    };

    try {
      const response = await fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://api.grants.gov/v1/api/search2'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) throw new Error(`Proxy error: ${response.status}`);

      const proxyData = await response.json();
      const data = JSON.parse(proxyData.contents);
      const opportunities = data.opportunities || [];

      loading.textContent = opportunities.length 
        ? `${opportunities.length} opportunities found` 
        : 'No matching opportunities found. Try different keywords.';

      opportunities.forEach(opp => {
        const div = document.createElement('div');
        div.className = 'grant';
        const funding = opp.estimatedTotalProgramFunding 
          ? '$' + Number(opp.estimatedTotalProgramFunding).toLocaleString() 
          : 'Not specified';
        const closeDate = opp.closeDate 
          ? new Date(opp.closeDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) 
          : 'Open until further notice';
        const description = opp.synopsis?.synopsisDescription 
          ? opp.synopsis.synopsisDescription.substring(0, 400) + '...' 
          : 'No description available.';

        div.innerHTML = `
          <h3><a href="https://www.grants.gov/search-results-detail/${opp.opportunityId}" target="_blank">${opp.title || 'Untitled Opportunity'}</a></h3>
          <p><strong>Agency:</strong> ${opp.agency || 'N/A'}<br>
             <strong>Opportunity Number:</strong> ${opp.opportunityNumber || 'N/A'}<br>
             <strong>Estimated Total Funding:</strong> ${funding}<br>
             <strong>Application Due Date:</strong> ${closeDate}<br><br>
             <strong>Description:</strong> ${description}</p>
        `;
        resultsDiv.appendChild(div);
      });
    } catch (error) {
      loading.textContent = 'Unable to load opportunities right now. Please try again later.';
      console.error('Grant fetch error:', error);
    }
  }

  window.onload = () => {
    document.getElementById('keyword').value = '';
    searchGrants();
  };
</script>
